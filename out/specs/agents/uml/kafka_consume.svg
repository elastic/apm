<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="424px" preserveAspectRatio="none" style="width:496px;height:424px;background:#FFFFFF;" version="1.1" viewBox="0 0 496 424" width="496px" zoomAndPan="magnify"><defs><filter height="300%" id="f1g4rsmaee64o2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1g4rsmaee64o2)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="170" y="228.0703"/><rect fill="#017D73" filter="url(#f1g4rsmaee64o2)" height="68.5547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="306.5" y="51.6094"/><rect fill="#017D73" filter="url(#f1g4rsmaee64o2)" height="43.0273" style="stroke:#A80036;stroke-width:1.0;" width="10" x="306.5" y="319.4492"/><rect fill="#FFFFFF" filter="url(#f1g4rsmaee64o2)" height="85.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="429.5" y="172.3672"/><rect fill="#FFFFFF" filter="url(#f1g4rsmaee64o2)" height="303.8672" style="stroke:#000000;stroke-width:2.0;" width="473.5" x="9" y="58.6094"/><rect fill="#FFFFFF" filter="url(#f1g4rsmaee64o2)" height="168.1094" style="stroke:#000000;stroke-width:2.0;" width="453.5" x="19" y="187.3672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="175" x2="175" y1="41.6094" y2="379.4766"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="311" x2="311" y1="41.6094" y2="379.4766"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="434.5" x2="434.5" y1="41.6094" y2="379.4766"/><rect fill="#FEFECE" filter="url(#f1g4rsmaee64o2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="162" x="92" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="148" x="99" y="26.5332">Application (Consumer)</text><rect fill="#FEFECE" filter="url(#f1g4rsmaee64o2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="162" x="92" y="378.4766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="148" x="99" y="400.0098">Application (Consumer)</text><rect fill="#FEFECE" filter="url(#f1g4rsmaee64o2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="83" x="268" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69" x="275" y="26.5332">APM agent</text><rect fill="#FEFECE" filter="url(#f1g4rsmaee64o2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="83" x="268" y="378.4766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69" x="275" y="400.0098">APM agent</text><path d="M411.5,14 L457.5,14 C462.5,14 462.5,27.8047 462.5,27.8047 C462.5,27.8047 462.5,41.6094 457.5,41.6094 L411.5,41.6094 C406.5,41.6094 406.5,27.8047 406.5,27.8047 C406.5,27.8047 406.5,14 411.5,14 " fill="#FEFECE" filter="url(#f1g4rsmaee64o2)" style="stroke:#A80036;stroke-width:2.0;"/><path d="M457.5,14 C452.5,14 452.5,27.8047 452.5,27.8047 C452.5,41.6094 457.5,41.6094 457.5,41.6094 " fill="none" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="411.5" y="33.5332">Kafka</text><path d="M411.5,378.4766 L457.5,378.4766 C462.5,378.4766 462.5,392.2813 462.5,392.2813 C462.5,392.2813 462.5,406.0859 457.5,406.0859 L411.5,406.0859 C406.5,406.0859 406.5,392.2813 406.5,392.2813 C406.5,392.2813 406.5,378.4766 411.5,378.4766 " fill="#FEFECE" filter="url(#f1g4rsmaee64o2)" style="stroke:#A80036;stroke-width:2.0;"/><path d="M457.5,378.4766 C452.5,378.4766 452.5,392.2813 452.5,392.2813 C452.5,406.0859 457.5,406.0859 457.5,406.0859 " fill="none" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="411.5" y="398.0098">Kafka</text><rect fill="#FFFFFF" filter="url(#f1g4rsmaee64o2)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="170" y="228.0703"/><rect fill="#017D73" filter="url(#f1g4rsmaee64o2)" height="68.5547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="306.5" y="51.6094"/><rect fill="#017D73" filter="url(#f1g4rsmaee64o2)" height="43.0273" style="stroke:#A80036;stroke-width:1.0;" width="10" x="306.5" y="319.4492"/><rect fill="#FFFFFF" filter="url(#f1g4rsmaee64o2)" height="85.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="429.5" y="172.3672"/><path d="M9,58.6094 L82,58.6094 L82,66.6094 L72,76.6094 L9,76.6094 L9,58.6094 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="303.8672" style="stroke:#000000;stroke-width:2.0;" width="473.5" x="9" y="58.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="28" x="24" y="73.1045">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="64" x="97" y="72.0283">[while true]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="316.5" x2="358.5" y1="119.1641" y2="119.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="358.5" x2="358.5" y1="119.1641" y2="132.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="311.5" x2="358.5" y1="132.1641" y2="132.1641"/><polygon fill="#A80036" points="321.5,128.1641,311.5,132.1641,321.5,136.1641,317.5,132.1641" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="323.5" y="114.3076">transaction.End()</text><path d="M68,81.9609 L68,140.9609 L297,140.9609 L297,91.9609 L287,81.9609 L68,81.9609 " fill="#FBFB77" filter="url(#f1g4rsmaee64o2)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M287,81.9609 L287,91.9609 L297,91.9609 L287,81.9609 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="208" x="74" y="100.4561">End current consume transaction</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="78" y="116.8076"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="74" y="133.1592">If it exists</text><polygon fill="#A80036" points="417.5,168.3672,427.5,172.3672,417.5,176.3672,421.5,172.3672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="175" x2="423.5" y1="172.3672" y2="172.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="133" x="182" y="167.5107">consumer.Consume()</text><path d="M19,187.3672 L191,187.3672 L191,195.3672 L181,205.3672 L19,205.3672 L19,187.3672 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="168.1094" style="stroke:#000000;stroke-width:2.0;" width="453.5" x="19" y="187.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="127" x="34" y="201.8623">Message processing</text><polygon fill="#A80036" points="191,224.0703,181,228.0703,191,232.0703,187,228.0703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="185" x2="428.5" y1="228.0703" y2="228.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="197" y="223.2139">message</text><line style="stroke:#A80036;stroke-width:1.0;" x1="311.5" x2="358.5" y1="306.4492" y2="306.4492"/><line style="stroke:#A80036;stroke-width:1.0;" x1="358.5" x2="358.5" y1="306.4492" y2="319.4492"/><line style="stroke:#A80036;stroke-width:1.0;" x1="317.5" x2="358.5" y1="319.4492" y2="319.4492"/><polygon fill="#A80036" points="327.5,315.4492,317.5,319.4492,327.5,323.4492,323.5,319.4492" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="323.5" y="301.5928">transaction.Start()</text><path d="M29,271.0703 L29,346.0703 L297,346.0703 L297,281.0703 L287,271.0703 L29,271.0703 " fill="#FBFB77" filter="url(#f1g4rsmaee64o2)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M287,271.0703 L287,281.0703 L297,281.0703 L287,271.0703 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="200" x="35" y="289.5654">Start new consume transaction.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="39" y="305.917"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247" x="35" y="322.2686">Check message headers for Trace Context</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="35" y="338.6201">and set on transaction, if present.</text><!--MD5=[c8b2d3a44ee058e862a8ae729751b0d3]
@startuml kafka_consume
participant "Application (Consumer)" as app
participant "APM agent" as apm
queue       Kafka as queue

loop while true
    activate apm #017D73 
    apm -> apm: transaction.End()  
    note left
        **End current consume transaction**

        If it exists
    end note
    deactivate apm
    app -> queue: **consumer.Consume()**
    activate queue

    group Message processing
        queue - -> app: message
        activate app
        deactivate queue

        apm -> apm: transaction.Start()
        activate apm #017D73
        note left
            **Start new consume transaction.**

            Check message headers for Trace Context
            and set on transaction, if present.
        end note
    end

    deactivate app
    deactivate apm
end
@enduml

PlantUML version 1.2021.7(Sun May 23 22:40:07 AEST 2021)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: Cp1252
Language: en
Country: AU
--></g></svg>